name: Build and Push Docker Image to GitHub Packages

permissions:
  contents: write
  packages: write

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract Version from Gradle file
        id: get_version
        run: |
          # Use awk to find the line starting with 'version =', extract the third field (the version string),
          # and remove any surrounding quotes.
          VERSION=$(awk '/^version =/ {print $3}' build.gradle.kts | tr -d '"')
          echo "Extracted project version: $VERSION"
          # Export the version as an environment variable for subsequent steps
          echo "PROJECT_VERSION=$VERSION" >> $GITHUB_ENV
      - name: Create Git Tag (if it doesn't exist)
        id: tag_release
        run: |
          TAG_NAME="v${{ env.PROJECT_VERSION }}"
          
          # Check if the tag already exists locally
          if git rev-parse $TAG_NAME >/dev/null 2>&1; then
          echo "Tag $TAG_NAME already exists locally. Skipping tag creation."
          else
          echo "Creating and pushing new tag: $TAG_NAME"
          # Configure Git user for the commit
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Create and push the tag
          git tag $TAG_NAME
          git push origin $TAG_NAME
          fi
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and Push Docker Image to GHCR
        run: |
          IMAGE_REPO_PATH=${GITHUB_REPOSITORY,,}
          IMAGE_FULL_TAG="ghcr.io/${IMAGE_REPO_PATH}:${{ env.PROJECT_VERSION }}"
          
          echo "Building image with tag: $IMAGE_FULL_TAG"
          
          # Executes the Spring Boot build command and pushes the image
          ./gradlew bootBuildImage \
          --imageName "$IMAGE_FULL_TAG" \
          --publishImage
